<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Management System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0px 4px 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }
    .stat-box {
      background: #007BFF;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      margin: 0 10px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    input[type="text"], select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #007BFF;
      color: #fff;
      cursor: pointer;
    }
    a.button, button {
      display: inline-block;
      padding: 8px 12px;
      margin: 5px;
      background-color: #28a745;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    a.button.delete {
      background-color: #dc3545;
    }
    a.button.edit {
      background-color: #ffc107;
      color: #000;
    }
    .form-container {
      margin-top: 20px;
      display: none;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    input[type="number"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .export-buttons {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Student Management System</h1>

    <!-- Statistics -->
    <div class="stats">
      <div class="stat-box">
        <h2 id="totalStudents">0</h2>
        <p>Total Students</p>
      </div>
      <div class="stat-box">
        <h2 id="averageMarks">0</h2>
        <p>Average Marks</p>
      </div>
      <div class="stat-box">
        <h2 id="highestMarks">0</h2>
        <p>Highest Marks</p>
      </div>
      <div class="stat-box">
        <h2 id="lowestMarks">0</h2>
        <p>Lowest Marks</p>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search by name...">
      <select id="marksFilter">
        <option value="">Filter by Marks</option>
        <option value="50">Above 50</option>
        <option value="75">Above 75</option>
        <option value="90">Above 90</option>
      </select>
      <div class="export-buttons">
        <button onclick="exportTableToCSV()">Export CSV</button>
        <button onclick="exportTableToExcel()">Export Excel</button>
      </div>
      <a href="#" class="button" id="showForm">Add New Student</a>
    </div>

    <!-- Add/Edit Student Form -->
    <div class="form-container" id="studentFormContainer">
      <form id="studentForm" method="POST">
        <input type="hidden" name="id" id="studentId">
        <input type="text" name="name" id="name" placeholder="Name" required>
        <input type="number" name="age" id="age" placeholder="Age" required>
        <input type="number" name="marks" id="marks" placeholder="Marks" required>
        <button type="submit" id="submitButton">Add Student</button>
      </form>
    </div>

    <!-- Students Table -->
    <table id="studentsTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">ID</th>
          <th onclick="sortTable(1)">Name</th>
          <th onclick="sortTable(2)">Age</th>
          <th onclick="sortTable(3)">Marks</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for student in students %}
        <tr>
          <td>{{ student.id }}</td>
          <td>{{ student.name }}</td>
          <td>{{ student.age }}</td>
          <td>{{ student.marks }}</td>
          <td>
            <a href="#" class="button edit" onclick="editStudent('{{ student.id }}','{{ student.name }}','{{ student.age }}','{{ student.marks }}')">Edit</a>
            <a href="{{ url_for('delete_student', id=student.id) }}" class="button delete" onclick="return confirm('Are you sure?')">Delete</a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5">No students found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    const showFormBtn = document.getElementById('showForm');
    const formContainer = document.getElementById('studentFormContainer');
    const form = document.getElementById('studentForm');
    const submitButton = document.getElementById('submitButton');
    const studentIdField = document.getElementById('studentId');
    const nameField = document.getElementById('name');
    const ageField = document.getElementById('age');
    const marksField = document.getElementById('marks');

    // Toggle form
    showFormBtn.addEventListener('click', () => {
      resetForm();
      form.action = "{{ url_for('add_student') }}";
      submitButton.textContent = "Add Student";
      formContainer.style.display = formContainer.style.display === 'block' ? 'none' : 'block';
    });

    // Load form with student data for editing
    function editStudent(id, name, age, marks) {
      studentIdField.value = id;
      nameField.value = name;
      ageField.value = age;
      marksField.value = marks;
      form.action = "/edit/" + id;
      submitButton.textContent = "Update Student";
      formContainer.style.display = 'block';
    }

    // Reset form for adding
    function resetForm() {
      studentIdField.value = "";
      nameField.value = "";
      ageField.value = "";
      marksField.value = "";
    }

    // Search & Filter
    const searchInput = document.getElementById("searchInput");
    const marksFilter = document.getElementById("marksFilter");
    const table = document.getElementById("studentsTable").getElementsByTagName("tbody")[0];

    searchInput.addEventListener("keyup", filterTable);
    marksFilter.addEventListener("change", filterTable);

    function filterTable() {
      const searchValue = searchInput.value.toLowerCase();
      const marksValue = parseInt(marksFilter.value) || 0;
      for (let row of table.rows) {
        const name = row.cells[1].textContent.toLowerCase();
        const marks = parseInt(row.cells[3].textContent);
        const match = name.includes(searchValue) && (marksValue === 0 || marks >= marksValue);
        row.style.display = match ? "" : "none";
      }
      updateStats();
    }

    // Sort table
    function sortTable(n) {
      let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
      const table = document.getElementById("studentsTable");
      switching = true;
      dir = "asc"; 
      while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          x = rows[i].getElementsByTagName("TD")[n];
          y = rows[i + 1].getElementsByTagName("TD")[n];
          if (dir === "asc" && Number(x.innerHTML) > Number(y.innerHTML)) {
            shouldSwitch = true;
            break;
          } else if (dir === "desc" && Number(x.innerHTML) < Number(y.innerHTML)) {
            shouldSwitch = true;
            break;
          }
        }
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++;
        } else {
          if (switchcount === 0 && dir === "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    }

    // Stats calculation
    function updateStats() {
      const rows = table.rows;
      let total = 0, marksSum = 0, highest = 0, lowest = 1000;
      for (let row of rows) {
        if (row.style.display !== "none") {
          total++;
          const marks = parseInt(row.cells[3].textContent);
          marksSum += marks;
          if (marks > highest) highest = marks;
          if (marks < lowest) lowest = marks;
        }
      }
      document.getElementById("totalStudents").textContent = total;
      document.getElementById("averageMarks").textContent = total ? (marksSum / total).toFixed(1) : 0;
      document.getElementById("highestMarks").textContent = total ? highest : 0;
      document.getElementById("lowestMarks").textContent = total ? lowest : 0;
    }

    updateStats();

    // Export CSV
    function exportTableToCSV() {
      let csv = [];
      const rows = document.querySelectorAll("#studentsTable tr");
      for (let row of rows) {
        let cols = row.querySelectorAll("td, th");
        let rowData = [];
        for (let col of cols) {
          rowData.push(col.innerText);
        }
        csv.push(rowData.join(","));
      }
      downloadCSV(csv.join("\n"), "students.csv");
    }

    function downloadCSV(csv, filename) {
      const csvFile = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.download = filename;
      link.href = window.URL.createObjectURL(csvFile);
      link.click();
    }

    // Export Excel
    function exportTableToExcel() {
      let table = document.getElementById("studentsTable");
      let html = table.outerHTML;
      let blob = new Blob(['\ufeff', html], { type: "application/vnd.ms-excel" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "students.xls";
      a.click();
    }
  </script>
</body>
</html>
